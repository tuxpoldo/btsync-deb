#!/bin/sh
# postinst script for btsync-common
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
configure)
	set +e
	# fix this insane i386/geode stuff...
	if [ -f /usr/lib/btsync-common/btsync-core-i686 ]; then
		# ok - we are a i386 package....
		if grep -i "geode" /proc/cpuinfo > /dev/null ; then
			ln -sf btsync-core-geode /usr/lib/btsync-common/btsync-core
		else
			ln -sf btsync-core-i686 /usr/lib/btsync-common/btsync-core
		fi
	fi
	# try to fix all that annoying arm stuff that
	# may prevent btsync from running....
	if [ $(uname -m | grep -c arm) -gt 0 ]; then
		# it's an arm architecure
		if [ ! -e /lib/ld-linux.so.3 ]; then
			# strange situation reported by schlegel11. we try
			# to fix it...
			if [ -e /lib/arm-linux-gnueabihf/ld-linux.so.3 ]; then
				ln -s /lib/arm-linux-gnueabihf/ld-linux.so.3 /lib/ld-linux.so.3
			elif [ -e /lib/arm-linux-gnueabihf/ld-2.13.so ]; then
				ln -s /lib/arm-linux-gnueabihf/ld-2.13.so /lib/ld-linux.so.3
			fi
		fi
	fi
	DAEMON=/usr/lib/btsync-common/btsync-core
	if [ -r /proc/cpu/alignment ]; then
		if ! ${DAEMON} --help > /dev/null 2> /dev/null; then
			# something is wrong
			if ${DAEMON} --help | grep -i "Alignment error" > /dev/null 2> /dev/null; then
				# adjust arm alignment handler
				echo 2 > /proc/cpu/alignment
			fi
		fi
	fi
	SAMPLECFG=/usr/share/doc/btsync-common/btsync.conf.sample
	echo '//!/usr/lib/btsync-common/btsync-core --config' > ${SAMPLECFG}
	echo '//' >> ${SAMPLECFG}
	echo '// (c) 2013-2014 BitTorrent Inc.' >> ${SAMPLECFG}
	echo '//' >> ${SAMPLECFG}
	echo '// This btsync configuration file features the complete set of' >> ${SAMPLECFG}
	echo '// commented configuration directives' >> ${SAMPLECFG}
	echo '//' >> ${SAMPLECFG}
	${DAEMON} --dump-sample-config >> ${SAMPLECFG}
	touch -r ${DAEMON} ${SAMPLECFG}
	# handle btsync-user if installed
	if [ -f /var/run/btsync-user-updating ]; then
		rm -f /var/run/btsync-user-updating
	fi
	set -e
	;;
abort-upgrade|abort-remove|abort-deconfigure)
	;;
*)
	echo "postinst called with unknown argument \`$1'" >&2
	exit 1
	;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
